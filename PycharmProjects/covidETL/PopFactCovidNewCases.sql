use covid 
if OBJECT_ID('tempdb..#temp') is not null
	drop table #temp

select Unpvt.date,Unpvt.Country, Unpvt.new_cases
into #temp
from [covid].[dbo].stg_source_new_cases c

unpivot (
new_cases for Country in (
Afghanistan,
Albania,
Algeria,
Andorra,
Angola,
Anguilla,
AntiguaandBarbuda,
Argentina,
Armenia,
Aruba,
Australia,
Austria,
Azerbaijan,
Bahamas,
Bahrain,
Bangladesh,
Barbados,
Belarus,
Belgium,
Belize,
Benin,
Bermuda,
Bhutan,
Bolivia,
BonaireSintEustatiusandSaba,
BosniaandHerzegovina,
Botswana,
Brazil,
BritishVirginIslands,
Brunei,
Bulgaria,
BurkinaFaso,
Burundi,
Cambodia,
Cameroon,
Canada,
CapeVerde,
CaymanIslands,
CentralAfricanRepublic,
Chad,
Chile,
China,
Colombia,
Comoros,
Congo,
CostaRica,
CotedIvoire,
Croatia,
Cuba,
Curacao,
Cyprus,
CzechRepublic,
DemocraticRepublicofCongo,
Denmark,
Djibouti,
Dominica,
DominicanRepublic,
Ecuador,
Egypt,
ElSalvador,
EquatorialGuinea,
Eritrea,
Estonia,
Ethiopia,
FaeroeIslands,
FalklandIslands,
Fiji,
Finland,
France,
FrenchPolynesia,
Gabon,
Gambia,
Georgia,
Germany,
Ghana,
Gibraltar,
Greece,
Greenland,
Grenada,
Guam,
Guatemala,
Guernsey,
Guinea,
GuineaBissau,
Guyana,
Haiti,
Honduras,
Hungary,
Iceland,
India,
Indonesia,
International,
Iran,
Iraq,
Ireland,
IsleofMan,
Israel,
Italy,
Jamaica,
Japan,
Jersey,
Jordan,
Kazakhstan,
Kenya,
Kosovo,
Kuwait,
Kyrgyzstan,
Laos,
Latvia,
Lebanon,
Lesotho,
Liberia,
Libya,
Liechtenstein,
Lithuania,
Luxembourg,
Macedonia,
Madagascar,
Malawi,
Malaysia,
Maldives,
Mali,
Malta,
Mauritania,
Mauritius,
Mexico,
Moldova,
Monaco,
Mongolia,
Montenegro,
Montserrat,
Morocco,
Mozambique,
Myanmar,
Namibia,
Nepal,
Netherlands,
NewCaledonia,
NewZealand,
Nicaragua,
Niger,
Nigeria,
NorthernMarianaIslands,
Norway,
Oman,
Pakistan,
Palestine,
Panama,
PapuaNewGuinea,
Paraguay,
Peru,
Philippines,
Poland,
Portugal,
PuertoRico,
Qatar,
Romania,
Russia,
Rwanda,
SaintKittsandNevis,
SaintLucia,
SaintVincentandtheGrenadines,
SanMarino,
SaoTomeandPrincipe,
SaudiArabia,
Senegal,
Serbia,
Seychelles,
SierraLeone,
Singapore,
SintMaartenDutchpart,
Slovakia,
Slovenia,
Somalia,
SouthAfrica,
SouthKorea,
SouthSudan,
Spain,
SriLanka,
Sudan,
Suriname,
Swaziland,
Sweden,
Switzerland,
Syria,
Taiwan,
Tajikistan,
Tanzania,
Thailand,
Timor,
Togo,
TrinidadandTobago,
Tunisia,
Turkey,
TurksandCaicosIslands,
Uganda,
Ukraine,
UnitedArabEmirates,
UnitedKingdom,
UnitedStates,
UnitedStatesVirginIslands,
Uruguay,
Uzbekistan,
Vatican,
Venezuela,
Vietnam,
WesternSahara,
Yemen,
Zambia,
Zimbabwe)
) as Unpvt;

if OBJECT_ID('tempdb..#tempFact') is not null
	drop table #tempFact
select
format(date,'yyyyMMdd') DateKey,
Country CountryKey,
new_cases NewCases

into #tempFact

from #temp


merge #tempFact t using DimCountry s
on (t.CountryKey = s.CountryName)

when matched then update set
	t.CountryKey = s.CountryKey;


merge FactCovid t using #tempFact s
on (t.DateKey = s.DateKey and t.CountryKey =s.CountryKey)

when matched then update set
	t.NewCases = s.NewCases

when not matched by target
	then insert (NewCases)
	values (s.NewCases);

select * from FactCovid
